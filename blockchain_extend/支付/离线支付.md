# 离线支付

+ 互联网支付工具常用的离线支付解决方案
+ 公交地铁系统使用的离线支付解决方案
+ DCEP的离线支付解决方案
+ 区块链中的离线支付解决方案

## 互联网支付工具常用的离线支付解决方案

### 离线支付的关键点一：付款码可以离线生成

付款码生成过程：

1、用户打开支付宝App时，会向服务端申请令牌种子;

2、支付宝服务器会根据算法生成一个令牌种子，返回给支付宝App;

3、支付宝App得到令牌种子后，根据算法生成付款码(可以离线生成)

### 离线支付的关键点二：付款码是一次性且实时更新

1、支付宝App生成的付款码会包含有用户标识、令牌值等信息;

2、付款码是一次性的，且每分钟会更新一次。这样就不会出现别人把你的付款码打印出来再去付款。

### 离线支付的关键点三：付款码能离线，扫码枪需在线

付款码离线支付过程：

1、线下支付时，用户打开支付宝App，出示付款码(可以离线);

2、商家用扫码枪读取付款码，并上传至支付宝服务器;

3、支付宝服务器收到商家传来的付款码后，与令牌系统里保存的信息进行对比;

4、比对通过则创建支付订单，并返回给商户订单信息，如果余额足够便可完成支付。

也就是说，付款方可以离线，但收款方得在线。通过在线的收款方搭桥，将离线的付款信息传到支付宝服务器端进行校验。

### 离线支付的特殊情况：付款方、收款方双离线

如果双方都离线，就扫码枪读取付款码本地保存先记账，等联网后上传至支付宝服务器做安全验证再扣款。

## 公交地铁系统使用的离线支付解决方案

公交卡地铁卡更像是一种预付费卡，支付方向只有一个，从用户到系统。

他们采用典型的双离线支付，预付费卡余额信息在客户端设备和服务端都有记录。

每次支付操作，客户端设备更新本设备的预付费卡余额信息，同时设备读卡器保存交易记录和预付费卡余额信息。

公交车或者地铁闸机上的设备读卡器会每隔一段时间将数据发送到服务端，这个时候就会做清算和对账。

## DCEP的离线支付解决方案

DCEP离线工作流程:

例如A用户的电子钱包中有D100，现在A、B用户都离线的情况下需要支付D100给B用户。

1、A 用户打开 APP 后，选择离线支付功能，输入付款金额和接收方信息后点击支付。

2、A 用户对上述信息利用自己的私钥进行签名，并用收款人的手机号或者其他标识收款人的信息通过 NFC 等近场通讯的方式进行加密传输。

3、B 用户 APP 接收到加密信息后，解密并验证 D 币的合法性，以及金额是否等值。此时对于 A、B 用户来说已经完成了双离线支付，但是此时 B 其实并没有真正收到 A 转给他的 D 币，在 APP 界面上来说，接受到的 D 币应该是出于不正常状态（不可用）。接下来，B 用户的 APP 会在联机状态后，将支付信息发送给商业银行数字货币系统。

4、商业银行收到这个支付信息后，在校验了合法性后，会将这个信息发送给央行数字货币系统。

5、央行数字货币系统收到支付信息后，在完成与在线支付一样的校验后，就会更改属主，将原本属于 A 的 D 币，变更为 B 用户，最后将结果返回给商业银行。

6、商业银行收到成功信息后，通知 A、B 用户 APP 发送交易成功的消息，此时 B 用户接收到的 D 币状态才会变成可用状态。

总的来说，该过程可以类比为付款方现场开具支票，收款方事后凭支票去银行兑现。

从以上流程可知：

1、如果 A 转给 B，那么 B 在联网之前，A 转给 B 的 D 币 B 是无法转给 C 的，这个双离线支付并不能完成链式的支付。

2、在上述双离线支付场景中，电子支付对离线支付过程中可能出现的重复支付(双花)的检查是滞后的，即只能在支付完成后实施。若用户实施了双花，是通过事后追责的形式来处理的，即对不良记录将录入征信系统以作惩戒。

3、系统在具体实现时，也可设定离线支付的最大支付额度（如1000元），以规避风险。

## 区块链中的离线支付解决方案

## 参考
[在没有网络的情况下，DCEP如何实现双离线支付](https://www.jianshu.com/p/005ad20f0f08)
[详解数字人民币的“硬件钱包”和“双离线支付”](https://www.mpaypass.com.cn/news/202011/02100820.html)
